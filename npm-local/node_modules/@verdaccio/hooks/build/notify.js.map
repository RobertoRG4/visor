{"version":3,"file":"notify.js","names":["_debug","_interopRequireDefault","require","_handlebars","_logger","_notifyRequest","e","__esModule","default","debug","buildDebug","compileTemplate","content","metadata","Promise","resolve","reject","handler","template","Handlebars","compile","error","handleNotify","notifyEntry","remoteUser","publishedPackage","regex","name","packagePattern","RegExp","packagePatternFlags","test","publisher","options","body","JSON","stringify","headers","Array","isArray","header","map","item","Object","is","key","hasOwnProperty","endpoint","Error","notifyRequest","method","sendNotification","notify","config","isSingle","keys","includes","response","results","allSettled","keyId","catch","logger","promiseValue","value"],"sources":["../src/notify.ts"],"sourcesContent":["/* eslint-disable no-undef */\nimport buildDebug from 'debug';\nimport Handlebars from 'handlebars';\n\nimport { logger } from '@verdaccio/logger';\nimport { Config, Notification, Package, RemoteUser } from '@verdaccio/types';\n\nimport { FetchOptions, notifyRequest } from './notify-request';\n\nconst debug = buildDebug('verdaccio:hooks');\n\nexport function compileTemplate(content, metadata) {\n  // FUTURE: multiple handlers\n  return new Promise((resolve, reject) => {\n    let handler;\n    try {\n      if (!handler) {\n        debug('compile default template handler %o', content);\n        const template: HandlebarsTemplateDelegate = Handlebars.compile(content);\n        return resolve(template(metadata));\n      }\n    } catch (error: any) {\n      debug('error  template handler %o', error);\n      reject(error);\n    }\n  });\n}\n\nexport async function handleNotify(\n  metadata: Partial<Package>,\n  notifyEntry,\n  remoteUser: Partial<RemoteUser>,\n  publishedPackage: string\n): Promise<boolean> {\n  let regex;\n  if (metadata.name && notifyEntry.packagePattern) {\n    regex = new RegExp(notifyEntry.packagePattern, notifyEntry.packagePatternFlags || '');\n    if (!regex.test(metadata.name)) {\n      return false;\n    }\n  }\n\n  let content;\n  // FIXME: publisher is not part of the expected types metadata\n  // @ts-ignore\n  if (typeof metadata?.publisher === 'undefined' || metadata?.publisher === null) {\n    // @ts-ignore\n    metadata = { ...metadata, publishedPackage, publisher: { name: remoteUser.name as string } };\n    debug('template metadata %o', metadata);\n    content = await compileTemplate(notifyEntry.content, metadata);\n  }\n\n  const options: FetchOptions = {\n    body: JSON.stringify(content),\n  };\n\n  // provides fallback support, it's accept an Object {} and Array of {}\n  if (notifyEntry.headers && Array.isArray(notifyEntry.headers)) {\n    const header = {};\n    // FIXME: we can simplify this\n    notifyEntry.headers.map(function (item): void {\n      if (Object.is(item, item)) {\n        for (const key in item) {\n          /* eslint no-prototype-builtins: 0 */\n          if (item.hasOwnProperty(key)) {\n            header[key] = item[key];\n          }\n        }\n      }\n    });\n    options.headers = header;\n  } else if (Object.is(notifyEntry.headers, notifyEntry.headers)) {\n    options.headers = notifyEntry.headers;\n  }\n\n  if (!notifyEntry.endpoint) {\n    debug('error due endpoint is missing');\n    throw new Error('missing parameter');\n  }\n\n  return notifyRequest(notifyEntry.endpoint, {\n    method: notifyEntry.method,\n    ...options,\n  });\n}\n\nexport function sendNotification(\n  metadata: Partial<Package>,\n  notify: Notification,\n  remoteUser: Partial<RemoteUser>,\n  publishedPackage: string\n): Promise<boolean> {\n  return handleNotify(metadata, notify, remoteUser, publishedPackage) as Promise<any>;\n}\n\nexport async function notify(\n  metadata: Partial<Package>,\n  config: Partial<Config>,\n  remoteUser: Partial<RemoteUser>,\n  publishedPackage: string\n): Promise<boolean[]> {\n  debug('init send notification');\n  if (config.notify) {\n    const isSingle = Object.keys(config.notify).includes('method');\n    if (isSingle) {\n      debug('send single notification');\n      try {\n        const response = await sendNotification(\n          metadata,\n          config.notify as Notification,\n          remoteUser,\n          publishedPackage\n        );\n        return [response];\n      } catch {\n        debug('error on sending single notification');\n        return [false];\n      }\n    } else {\n      debug('send multiples notification');\n      const results = await Promise.allSettled(\n        Object.keys(config.notify).map((keyId: string) => {\n          // @ts-ignore\n          const item = config.notify[keyId];\n          debug('send item %o', item);\n          return sendNotification(metadata, item, remoteUser, publishedPackage);\n        })\n      ).catch((error) => {\n        logger.error({ error }, 'notify request has failed: @error');\n      });\n\n      // @ts-ignore\n      return Object.keys(results).map((promiseValue) => results[promiseValue].value);\n    }\n  } else {\n    debug('no notifications configuration detected');\n    return [false];\n  }\n}\n"],"mappings":"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","ignoreList":[]}