{"version":3,"file":"local-fs.js","names":["_nodeFs","_interopRequireDefault","require","_nodePath","_debug","_lodash","_mkdirp","_streams","_fileLocking","_core","e","__esModule","default","_defineProperty","r","t","_toPropertyKey","Object","defineProperty","value","enumerable","configurable","writable","i","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","fileExist","exports","noSuchFile","resourceNotAvailable","pkgFileName","debug","buildDebug","getCode","getInternalError","getNotFound","errorUtils","fSError","message","code","err","tempFile","str","Math","random","substr","renameTmp","src","dst","_cb","cb","fs","unlink","process","platform","rename","tmp","LocalFS","constructor","path","logger","updatePackage","name","updateHandler","onWrite","transformPackage","onEnd","_lockAndReadJSON","json","locked","self","unLockCallback","lockError","_args","arguments","_unlockJSON","apply","_","isNil","deletePackage","packageName","callback","_getStorage","removePackage","rmdir","createPackage","_createFile","_convertToString","savePackage","_writeFile","readPackage","_readStorageFile","then","res","data","JSON","parse","toString","writeTarball","uploadStream","UploadTarball","_ended","on","pathName","access","fileNotFound","exists","emit","temporalName","join","replace","file","createWriteStream","removeTempFile","opened","pipe","done","onend","end","abort","readTarball","readTarballStream","ReadTarball","readStream","createReadStream","fd","fstat","stats","size","close","contents","open","Promise","resolve","reject","readFile","stringify","fileName","storagePath","dest","createTempFile","tempFilePath","writeFile","mkdirp","dirname","catch","lock","unlockFile"],"sources":["../src/local-fs.ts"],"sourcesContent":["/* eslint-disable no-undef */\n\nimport fs from 'node:fs';\nimport path from 'node:path';\n\nimport buildDebug from 'debug';\nimport _ from 'lodash';\nimport mkdirp from 'mkdirp';\nimport { UploadTarball, ReadTarball } from '@verdaccio/streams';\nimport { unlockFile, readFile } from '@verdaccio/file-locking';\nimport { Callback, Logger, Package, ILocalPackageManager, IUploadTarball } from '@verdaccio/legacy-types';\nimport {errorUtils, VerdaccioError} from '@verdaccio/core';\n\nexport const fileExist = 'EEXISTS';\nexport const noSuchFile = 'ENOENT';\nexport const resourceNotAvailable = 'EAGAIN';\nexport const pkgFileName = 'package.json';\n\nconst debug = buildDebug('verdaccio:plugin:local-storage-legacy:fs');\n\nconst { getCode, getInternalError, getNotFound } = errorUtils;\n\nexport const fSError = function(message: string, code = 409): VerdaccioError {\n  const err: VerdaccioError = getCode(code, message);\n  // FIXME: we should return http-status codes here instead, future improvement\n  // @ts-ignore\n  err.code = message;\n\n  return err;\n};\n\nconst tempFile = function(str): string {\n  return `${str}.tmp${String(Math.random()).substr(2)}`;\n};\n\nconst renameTmp = function(src, dst, _cb): void {\n  const cb = (err): void => {\n    if (err) {\n      fs.unlink(src, () => {});\n    }\n    _cb(err);\n  };\n\n  if (process.platform !== 'win32') {\n    return fs.rename(src, dst, cb);\n  }\n\n  // windows can't remove opened file,\n  // but it seem to be able to rename it\n  const tmp = tempFile(dst);\n  fs.rename(dst, tmp, function(err) {\n    fs.rename(src, dst, cb);\n    if (!err) {\n      fs.unlink(tmp, () => {});\n    }\n  });\n};\n\nexport type ILocalFSPackageManager = ILocalPackageManager & { path: string };\n\nexport default class LocalFS implements ILocalFSPackageManager {\n  public path: string;\n  public logger: Logger;\n\n  public constructor(path: string, logger: Logger) {\n    this.path = path;\n    this.logger = logger;\n  }\n\n  /**\n    *  This function allows to update the package thread-safely\n      Algorithm:\n      1. lock package.json for writing\n      2. read package.json\n      3. updateFn(pkg, cb), and wait for cb\n      4. write package.json.tmp\n      5. move package.json.tmp package.json\n      6. callback(err?)\n    * @param {*} name\n    * @param {*} updateHandler\n    * @param {*} onWrite\n    * @param {*} transformPackage\n    * @param {*} onEnd\n    */\n  public updatePackage(\n    name: string,\n    updateHandler: Callback,\n    onWrite: Callback,\n    transformPackage: Function,\n    onEnd: Callback\n  ): void {\n    this._lockAndReadJSON(pkgFileName, (err, json) => {\n      let locked = false;\n      const self = this;\n      // callback that cleans up lock first\n      const unLockCallback = function(lockError: Error): void {\n        // eslint-disable-next-line prefer-rest-params\n        const _args = arguments;\n\n        if (locked) {\n          self._unlockJSON(pkgFileName, () => {\n            // ignore any error from the unlock\n            if (lockError !== null) {\n              debug('lock file: %o has failed with error %o', name, lockError);\n            }\n\n            onEnd.apply(lockError, _args);\n          });\n        } else {\n          debug('file: %o has been updated', name);\n          onEnd(..._args);\n        }\n      };\n\n      if (!err) {\n        locked = true;\n        debug('file: %o has been locked', name);\n      }\n\n      if (_.isNil(err) === false) {\n        if (err.code === resourceNotAvailable) {\n          return unLockCallback(getInternalError('resource temporarily unavailable'));\n        } else if (err.code === noSuchFile) {\n          return unLockCallback(getNotFound());\n        } else {\n          return unLockCallback(err);\n        }\n      }\n\n      updateHandler(json, err => {\n        if (err) {\n          return unLockCallback(err);\n        }\n\n        onWrite(name, transformPackage(json), unLockCallback);\n      });\n    });\n  }\n\n  public deletePackage(packageName: string, callback: (err: NodeJS.ErrnoException | null) => void): void {\n    debug('delete a package %o', packageName);\n\n    return fs.unlink(this._getStorage(packageName), callback);\n  }\n\n  public removePackage(callback: (err: NodeJS.ErrnoException | null) => void): void {\n    debug('remove a package %o', this.path);\n\n    fs.rmdir(this._getStorage('.'), callback);\n  }\n\n  public createPackage(name: string, value: Package, cb: Callback): void {\n    debug('create a package %o', name);\n\n    this._createFile(this._getStorage(pkgFileName), this._convertToString(value), cb);\n  }\n\n  public savePackage(name: string, value: Package, cb: Callback): void {\n    debug('save a package %o', name);\n\n    this._writeFile(this._getStorage(pkgFileName), this._convertToString(value), cb);\n  }\n\n  public readPackage(name: string, cb: Callback): void {\n    debug('read a package %o', name);\n\n    this._readStorageFile(this._getStorage(pkgFileName)).then(\n      res => {\n        try {\n          const data: any = JSON.parse(res.toString('utf8'));\n\n          debug('read storage file %o has succeed', name);\n          cb(null, data);\n        } catch (err) {\n          debug('parse storage file %o has failed with error %o', name, err);\n          cb(err);\n        }\n      },\n      err => {\n        debug('read storage file %o has failed with error %o', name, err);\n\n        return cb(err);\n      }\n    );\n  }\n\n  public writeTarball(name: string): IUploadTarball {\n    const uploadStream = new UploadTarball({});\n    debug('write a tarball for a package %o', name);\n\n    let _ended = 0;\n    uploadStream.on('end', function() {\n      _ended = 1;\n    });\n\n    const pathName: string = this._getStorage(name);\n\n    fs.access(pathName, fileNotFound => {\n      const exists = !fileNotFound;\n      if (exists) {\n        uploadStream.emit('error', fSError(fileExist));\n      } else {\n        const temporalName = path.join(this.path, `${name}.tmp-${String(Math.random()).replace(/^0\\./, '')}`);\n        debug('write a temporal name %o', temporalName);\n        const file = fs.createWriteStream(temporalName);\n        const removeTempFile = (): void => fs.unlink(temporalName, () => {});\n        let opened = false;\n        uploadStream.pipe(file);\n\n        uploadStream.done = function(): void {\n          const onend = function(): void {\n            file.on('close', function() {\n              renameTmp(temporalName, pathName, function(err) {\n                if (err) {\n                  uploadStream.emit('error', err);\n                } else {\n                  uploadStream.emit('success');\n                }\n              });\n            });\n            file.end();\n          };\n          if (_ended) {\n            onend();\n          } else {\n            uploadStream.on('end', onend);\n          }\n        };\n\n        uploadStream.abort = function(): void {\n          if (opened) {\n            opened = false;\n            file.on('close', function() {\n              removeTempFile();\n            });\n          } else {\n            // if the file does not recieve any byte never is opened and has to be removed anyway.\n            removeTempFile();\n          }\n          file.end();\n        };\n\n        file.on('open', function() {\n          opened = true;\n          // re-emitting open because it's handled in storage.js\n          uploadStream.emit('open');\n        });\n\n        file.on('error', function(err) {\n          uploadStream.emit('error', err);\n        });\n      }\n    });\n\n    return uploadStream;\n  }\n\n  public readTarball(name: string): ReadTarball {\n    const pathName: string = this._getStorage(name);\n    debug('read a a tarball %o on path %o', name, pathName);\n\n    const readTarballStream = new ReadTarball({});\n\n    const readStream = fs.createReadStream(pathName);\n\n    readStream.on('error', function(err) {\n      debug('error on read a tarball %o with error %o', name, err);\n      readTarballStream.emit('error', err);\n    });\n\n    readStream.on('open', function(fd) {\n      fs.fstat(fd, function(err, stats) {\n        if (_.isNil(err) === false) {\n          debug('error on read a tarball %o with error %o', name, err);\n          return readTarballStream.emit('error', err);\n        }\n        readTarballStream.emit('content-length', stats.size);\n        readTarballStream.emit('open');\n        debug('open on read a tarball %o', name);\n        readStream.pipe(readTarballStream);\n      });\n    });\n\n    readTarballStream.abort = function(): void {\n      debug('abort on read a tarball %o', name);\n      readStream.close();\n    };\n\n    return readTarballStream;\n  }\n\n  private _createFile(name: string, contents: any, callback: Function): void {\n    debug(' create a new file: %o', name);\n\n    fs.open(name, 'wx', err => {\n      if (err) {\n        // native EEXIST used here to check exception on fs.open\n        if (err.code === 'EEXIST') {\n          debug('file %o cannot be created, it already exists: %o', name);\n          return callback(fSError(fileExist));\n        }\n      }\n\n      this._writeFile(name, contents, callback);\n    });\n  }\n\n  private _readStorageFile(name: string): Promise<any> {\n    return new Promise((resolve, reject): void => {\n      debug('reading the file: %o', name);\n\n      fs.readFile(name, (err, data) => {\n        if (err) {\n          debug('error reading the file: %o with error %o', name, err);\n          reject(err);\n        } else {\n          debug('read file %o succeed', name);\n\n          resolve(data);\n        }\n      });\n    });\n  }\n\n  private _convertToString(value: Package): string {\n    return JSON.stringify(value, null, '\\t');\n  }\n\n  private _getStorage(fileName = ''): string {\n    const storagePath: string = path.join(this.path, fileName);\n\n    return storagePath;\n  }\n\n  private _writeFile(dest: string, data: string, cb: Callback): void {\n    const createTempFile = (cb): void => {\n      const tempFilePath = tempFile(dest);\n\n      fs.writeFile(tempFilePath, data, err => {\n        if (err) {\n          debug('error on write the file: %o', dest);\n          return cb(err);\n        }\n\n        debug('creating a new file:: %o', dest);\n        renameTmp(tempFilePath, dest, cb);\n      });\n    };\n\n    createTempFile(err => {\n      if (err && err.code === noSuchFile) {\n        mkdirp(path.dirname(dest))\n          .then(() => {\n            createTempFile(cb);\n          })\n          .catch(err => {\n            return cb(err);\n          });\n      } else {\n        cb(err);\n      }\n    });\n  }\n\n  private _lockAndReadJSON(name: string, cb: Function): void {\n    const fileName: string = this._getStorage(name);\n\n    readFile(\n      fileName,\n      {\n        lock: true,\n        parse: true,\n      },\n      (err, res) => {\n        if (err) {\n          debug('error on lock and read json for file: %o', name);\n\n          return cb(err);\n        }\n        debug('lock and read json for file: %o', name);\n\n        return cb(null, res);\n      }\n    );\n  }\n\n  private _unlockJSON(name: string, cb: Function): void {\n    unlockFile(this._getStorage(name), cb);\n  }\n}\n"],"mappings":"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","ignoreList":[]}